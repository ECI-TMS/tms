{{!< dashboard}}
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-lg-6 bg-white p-4"><h3 class="fw-bold">Edit Project</h3></div>
  </div>
</div>

<div class="container mt-4 mb-4">
  <form
    action="/admin/program/update/{{program.ProgramID}}"
    method="post"
    id="programForm"
    class="row g-3 needs-validation justify-content-center"
  >
    <div class="col-lg-6 bg-white p-5">
      <div class="row gap-4">
        <div class="row">
          <div class="col-md-6">
            <label for="validationCustom01" class="form-label">Name</label>
            <input
              type="text"
              name="Name"
              class="form-control"
              id="validationCustom01"
              value="{{program.Name}}"
              required
            />
            <div class="valid-feedback">
              Looks good!
            </div>
          </div>
          {{! donor organization }}
          <div class="col-md-6">
            <label for="validationCustom04" class="form-label">Donor Organization</label>
            <select
              class="form-select"
              name="DonorOrganization"
              id="validationCustom04"
              required
            >
              <option disabled value="">Choose...</option>
              {{#each donors}}
                <option value="{{this.ThirdPartyID}}" {{#if (eq this.ThirdPartyID ../program.DonorOrganizationID)}}selected{{/if}}>
                  {{this.Name}}
                </option>
              {{/each}}
            </select>
            <div class="invalid-feedback">
              Please select a valid Organization.
            </div>
          </div>
        </div>
        {{! start date }}
        <div class="row">
          <div class="col-md-6">
            <label for="validationCustom02" class="form-label">Start Date</label>
            <input
              type="date"
              name="StartDate"
              class="form-control"
              id="validationCustom02"
              value="{{program.Startdate}}"
              required
            />
            <div class="valid-feedback">
              Looks good!
            </div>
          </div>
          {{! end date }}
          <div class="col-md-6">
            <label for="validationCustom02" class="form-label">End Date</label>
            <input
              type="date"
              name="EndDate"
              class="form-control"
              id="validationCustom02"
              value="{{program.EndDate}}"
              required
            />
            <div class="valid-feedback">
              Looks good!
            </div>
          </div>
        </div>
        <div class="col-12">
          <label for="validationCustom03" class="form-label">Description</label>
          <textarea
            name="Description"
            class="form-control"
            id="validationCustom03"
            required
          >{{program.Description}}</textarea>
          <div class="invalid-feedback">
            Please provide a valid Description.
          </div>
        </div>
        {{! Category }}
        <div class="row">
          <div class="col-md-6">
            <label for="validationCustom04" class="form-label">Category</label>
            <select
              class="form-select"
              name="Category"
              id="validationCustom04"
              required
            >
              <option disabled value="">Choose...</option>
              <option
                value="Climate-Resilient Livelihoods and Enterprise development"
                {{#if (eq ../program.Category "Climate-Resilient Livelihoods and Enterprise development")}}selected{{/if}}
              >Climate-Resilient Livelihoods and Enterprise development</option>
              <option 
                value="Youth and gender-based initiatives"
                {{#if (eq ../program.Category "Youth and gender-based initiatives")}}selected{{/if}}
              >Youth and gender-based initiatives</option>
              <option
                value="Good Governance and Institutional Strengthening"
                {{#if (eq ../program.Category "Good Governance and Institutional Strengthening")}}selected{{/if}}
              >Good Governance and Institutional Strengthening</option>
              <option 
                value="Health and Safety"
                {{#if (eq ../program.Category "Health and Safety")}}selected{{/if}}
              >Health and Safety</option>
              <option
                value="Technical Advisory Services for Microfinance"
                {{#if (eq ../program.Category "Technical Advisory Services for Microfinance")}}selected{{/if}}
              >Technical Advisory Services for Microfinance</option>
              <option 
                value="Research Monitoring and Evaluation"
                {{#if (eq ../program.Category "Research Monitoring and Evaluation")}}selected{{/if}}
              >Research Monitoring and Evaluation</option>
            </select>
            <div class="invalid-feedback">
              Please select a valid Category.
            </div>
          </div>
          {{! manager }}
          <div class="col-md-6">
            <label for="validationCustom04" class="form-label">Manager</label>
            <select
              class="form-select"
              name="Manager"
              id="validationCustom04"
              required
            >
              <option disabled value="">Choose...</option>
              {{#each managers}}
                <option value={{this.Username}} {{#if (eq this.Username ../managerUsername)}}selected{{/if}}>
                  {{this.Username}}
                </option>
              {{/each}}
            </select>
            <div class="invalid-feedback">
              Please select a valid Manager.
            </div>
          </div>
        </div>

        <div class="col-12 d-flex flex-wrap">
          {{#each documentType}}
            <div class="form-check form-switch ps-0 pe-4">
              <input
                class=""
                type="checkbox"
                id="flexSwitchCheckDefault-{{@index}}"
                name="documentTypes[]"
                value="{{this.DocumentTypeID}}"
                {{#if (includes ../selectedDocumentTypes this.DocumentTypeID)}}checked{{/if}}
              />
              <label
                class="form-check-label"
                for="flexSwitchCheckDefault-{{@index}}"
              >{{this.Name}}</label>
            </div>
          {{/each}}
        </div>
        <div class="col-12">
          <button class="btn btn-primary" type="submit">Update Program</button>
          <a href="/admin/programs" class="btn btn-secondary ms-2">Cancel</a>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
  const form = document.getElementById("programForm");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = {
      Name: form.elements["Name"].value,
      StartDate: form.elements["StartDate"].value,
      EndDate: form.elements["EndDate"].value,
      DonorOrganization: form.elements["DonorOrganization"].value,
      Description: form.elements["Description"].value,
      Category: form.elements["Category"].value,
      Manager: form.elements["Manager"]?.value || null,
      documentTypes: []
    };

    const checkboxes = form.querySelectorAll('input[name="documentTypes[]"]');
    checkboxes.forEach((checkbox) => {
      if (checkbox.checked) {
        formData.documentTypes.push(checkbox.value);
      }
    });

    // Ensure documentTypes is always present, even if empty
    if (!formData.documentTypes.length) {
      formData.documentTypes = undefined; // Let the backend handle validation
    }

    try {
      const res = await fetch("/admin/program/update/{{program.ProgramID}}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(formData),
      });

      const data = await res.json();

      if (res.ok && data.status) {
        alert(data.message || "Program updated successfully!");
        window.location.href = "/admin/programs";
      } else {
        alert(data.message || "Failed to update program. Please check your input.");
      }
    } catch (error) {
      alert("An unexpected error occurred. Please try again.");
      console.error("Fetch error:", error);
    }
  });
</script>
