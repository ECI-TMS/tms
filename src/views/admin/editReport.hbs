{{!< dashboard}}

<style>
  body {
    font-family: 'Poppins', sans-serif;
    background-color: #fff;
    color: #000;
  }

  .container {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
  }

  .form-container {
    background-color: #f8f9fa;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }

  .form-label {
    font-weight: 600;
    color: #2E5A92;
    margin-bottom: 8px;
  }

  .form-control {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 12px;
    font-size: 16px;
    transition: border-color 0.3s ease;
  }

  .form-control:focus {
    border-color: #2E5A92;
    box-shadow: 0 0 0 0.2rem rgba(46, 90, 146, 0.25);
  }

  .btn-primary {
    background-color: #2E5A92;
    border: none;
    padding: 12px 30px;
    border-radius: 8px;
    font-weight: 600;
    transition: background-color 0.3s ease;
  }

  .btn-primary:hover {
    background-color: #1e4a7a;
  }

  .btn-secondary {
    background-color: #6c757d;
    border: none;
    padding: 12px 30px;
    border-radius: 8px;
    font-weight: 600;
    transition: background-color 0.3s ease;
  }

  .btn-secondary:hover {
    background-color: #5a6268;
  }

  .current-file {
    background-color: #e9ecef;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 15px;
  }

  .current-file a {
    color: #2E5A92;
    text-decoration: none;
  }

  .current-file a:hover {
    text-decoration: underline;
  }

     .radio-group {
     display: flex;
     gap: 20px;
     margin-bottom: 20px;
   }

  .form-check {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .form-check-input {
    width: 18px;
    height: 18px;
  }

  /* Style for optgroup in dropdown */
  optgroup {
    font-weight: bold;
    color: #2E5A92;
    background-color: #f8f9fa;
  }

  optgroup option {
    font-weight: normal;
    color: #333;
    padding-left: 20px;
  }
</style>

<div class="container mt-4">
  <div class="form-container">
    <h3 class="mb-4 text-center" style="color: #2E5A92;">Edit Report</h3>
    
    <form
      action="/admin/report/update/{{report.ReportID}}"
      method="post"
      id="reportForm"
      enctype="multipart/form-data"
      class="needs-validation"
    >
      <div class="mb-3">
        <label for="reportName" class="form-label">Report Name</label>
        <input 
          type="text" 
          name="name" 
          class="form-control" 
          id="reportName" 
          value="{{report.Name}}"
          required 
        />
        <div class="valid-feedback">Looks good!</div>
      </div>

             <div class="mb-3">
         <label for="sessionID" class="form-label">Session</label>
         <select class="form-select" name="SessionID" id="SessionID" required>
           <option value="">Choose...</option>
           {{#each programs}}
             <optgroup label="{{this.Name}}">
               {{#each this.trainingsessions}}
                 <option 
                   value="{{this.SessionID}}" 
                   data-program-id="{{../ProgramID}}"
                   {{#if (isSelected this.SessionID ../report.SessionID)}}selected{{/if}}
                 >
                   Session : {{this.SessionID}}
                 </option>
               {{/each}}
             </optgroup>
           {{/each}}
         </select>
         <div class="invalid-feedback">
           Please select a valid Session.
         </div>
       </div>

             <input 
         type="hidden" 
         name="ProgramID" 
         id="programID" 
         value="{{report.ProgramID}}"
       />

             <div class="mb-3">
         <label class="form-label">Target Role</label>
         <div class="radio-group">
           <div class="form-check">
             <input 
               type="radio" 
               name="targetRole" 
               class="form-check-input" 
               id="isTrainer"
               value="trainer"
               {{#if report.isForTrainer}}checked{{/if}}
             />
             <label class="form-check-label" for="isTrainer">For Trainer</label>
           </div>
           <div class="form-check">
             <input 
               type="radio" 
               name="targetRole" 
               class="form-check-input" 
               id="isMonitor"
               value="monitor"
               {{#if report.isForMonitor}}checked{{/if}}
             />
             <label class="form-check-label" for="isMonitor">For Monitor</label>
           </div>
         </div>
       </div>

      {{#if report.FilePath}}
      <div class="mb-3">
        <label class="form-label">Current File</label>
        <div class="current-file">
          <a href="{{report.FilePath}}" download id="currentFileName">{{report.FilePath}}</a>
        </div>
      </div>
      {{/if}}

      <div class="mb-3">
        <label for="reportFile" class="form-label">
          {{#if report.FilePath}}Replace Template (Optional){{else}}Upload Template{{/if}}
        </label>
        <input 
          type="file" 
          name="template" 
          class="form-control" 
          id="reportFile"
          {{#unless report.FilePath}}required{{/unless}}
        />
        <div class="form-text">
          {{#if report.FilePath}}
            Leave empty to keep the current file
          {{else}}
            Please select a file to upload
          {{/if}}
        </div>
      </div>

      <div class="d-flex gap-2 justify-content-end">
        <a href="/admin/allReports" class="btn btn-secondary">Cancel</a>
        <button class="btn btn-primary" id="updateButton" type="submit">
          Update Report
        </button>
      </div>
    </form>
  </div>
</div>

<script defer src="/js/admin/editReport.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Handle filename display
    const currentFileName = document.getElementById('currentFileName');
    if (currentFileName) {
      const fullPath = currentFileName.textContent;
      const fileName = fullPath.split('\\').pop(); // Get the last part after the last backslash
      currentFileName.textContent = fileName;
    }

    // Handle session selection to update program ID
    const sessionSelect = document.getElementById('SessionID');
    const programIDInput = document.getElementById('programID');

    // Function to set program ID based on selected session
    function updateProgramID() {
      const selectedOption = sessionSelect.options[sessionSelect.selectedIndex];
      if (selectedOption && selectedOption.getAttribute('data-program-id')) {
        const programId = selectedOption.getAttribute('data-program-id');
        programIDInput.value = programId;
      }
    }

    // Set program ID on page load if session is already selected
    if (sessionSelect.value) {
      updateProgramID();
    }

    // Handle session selection changes
    sessionSelect.addEventListener('change', updateProgramID);

    // Force selection if no value is selected but there should be one
    setTimeout(() => {
      if (!sessionSelect.value && sessionSelect.options.length > 1) {
        // Find the option that matches the report's session ID
        const reportSessionID = '{{report.SessionID}}';
        for (let i = 0; i < sessionSelect.options.length; i++) {
          if (sessionSelect.options[i].value === reportSessionID) {
            sessionSelect.selectedIndex = i;
            updateProgramID();
            break;
          }
        }
      }
    }, 100);
  });
</script>
